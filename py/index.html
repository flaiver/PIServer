<HTML>
<BODY>

<script type="text/javascript">
	class SongList
	{
		constructor()
		{
			this.table = document.createElement("table");
			document.body.appendChild(this.table);
		}

		__createButton(action, callback)
		{
			var buttonCell = document.createElement('td');
			var button = document.createElement("button");
			button.innerHTML = action;
			button.onclick = callback;
			buttonCell.appendChild(button);
			return buttonCell;
		}
	
		__setNewDirectory(dirName)
		{
			var xhrSetDir = new XMLHttpRequest();
			xhrSetDir.open("POST", "", true);
			var paramsSet = "command=setDirectory&directory=" + dirName;
			xhrSetDir.send(paramsSet);
			xhrSetDir.onreadystatechange = function() 
			{
				if (xhrSetDir.readyState == 4 && xhrSetDir.status == 200)
				{
					location.reload();
				}
			};
		}	

		__createDirectory(dirName)
		{
			var self = this;
			var dirRow = document.createElement('tr');
			var dirCell = document.createElement('td');
			var dirLink = document.createElement('a');
			var dir = document.createTextNode(dirName);

			var goIntoDriectory = function()
			{
				var xhrGetDir = new XMLHttpRequest();
				xhrGetDir.open("POST", "", false);
				var paramsGet = "command=getDirectory";
				xhrGetDir.send(paramsGet);
				var directory = xhrGetDir.responseText;
				
				var fullPath = directory + "/" + dirName;
				self.__setNewDirectory(fullPath);	
			};

			dirLink.onclick = goIntoDriectory;
			dirLink.href = "#";
			dirLink.appendChild(dir);
			dirCell.appendChild(dirLink);
			dirRow.appendChild(dirCell)
			return dirRow;

		}

		addEntry(songName)
		{
			
			var songTR = document.createElement("tr");
			var playSong = function() 
			{ 	
				// get full path
				var xhrGetDir = new XMLHttpRequest();
				xhrGetDir.open("POST", "", false);
				var paramsGet = "command=getDirectory";
				xhrGetDir.send(paramsGet);
				var directory = xhrGetDir.responseText;
				var fullpath = directory + "/" + songName;
				
				var xhrSet = new XMLHttpRequest();
				xhrSet.open("POST", "", true);
				var paramsSet = "command=setSong&filename=" + fullpath;
				xhrSet.send(paramsSet);
				xhrSet.onreadystatechange = function() 
				{
					if (xhrSet.readyState == 4 && xhrSet.status == 200)
					{
						var xhr = new XMLHttpRequest();
						xhr.open("POST", "", true);
						var params = "command=play";
						xhr.send(params);
					}
				};
			};
			
			var stopSong =  function() 
			{ 
				var xhr = new XMLHttpRequest();
				xhr.open("POST", "", true);
				var params = "command=stop";
				xhr.send(params);
			 };

			var getMetaData = function()
			{
				// get full path
				var xhrGetDir = new XMLHttpRequest();
				xhrGetDir.open("POST", "", false);
				var paramsGet = "command=getDirectory";
				xhrGetDir.send(paramsGet);
				var directory = xhrGetDir.responseText;
				var fullpath = directory + "/" + songName;
				report(fullpath);
			}

			var songNameCell = document.createElement('td');
			var songNameTextNode = document.createTextNode(songName);
  			songNameCell.appendChild(songNameTextNode);
			getMetaData();
			
			var playButtonCell = this.__createButton("Play", playSong);
			var stopButtonCell = this.__createButton("Stop", stopSong);
			songTR.appendChild(songNameCell);
			songTR.appendChild(playButtonCell);
			songTR.appendChild(stopButtonCell);
			this.table.appendChild(songTR);
	 	}

		queryDirectories()
		{
			var self = this;
			var xhrDirectory = new XMLHttpRequest();
			xhrDirectory.open('POST', "", false)

			//Send the proper header information along with the request
			xhrDirectory.setRequestHeader("Content-type", "application/x-www-form-urlencoded");
			var params = "command=getSubDirectories";
			xhrDirectory.send(params);
			
			if (xhrDirectory.readyState == 4 && xhrDirectory.status == 200) 
			{
				var directoryList = xhrDirectory.responseText.split('#');
				directoryList.forEach(function(k, v) 
				{
					var row = self.__createDirectory(k);
					self.table.appendChild(row);
				});
			}

		}

		querySongs()
		{
			var self = this;
			var xhr = new XMLHttpRequest();
			xhr.open('POST', "", true);
			
			//Send the proper header information along with the request
			xhr.setRequestHeader("Content-type", "application/x-www-form-urlencoded");
			var params = "command=getSongList";
			xhr.send(params);

			var receiveSongList = function()
			{
				if (xhr.readyState == 4 && xhr.status == 200) 
				{
					var response = xhr.responseText;
					if (response != "")
					{
						var songList = response.split('#');
						songList.forEach(
							function(k, v)
							{
								self.addEntry(k);
							}
						);
					}
				}
			};
			
			xhr.onreadystatechange = receiveSongList; 
		}

		__gotoParentDirectory()
		{
			var xhrGotoParent = new XMLHttpRequest();
			xhrGotoParent.open("POST", "", true);
			var paramsGotoParent = "command=gotoParent";
			xhrGotoParent.send(paramsGotoParent);
			xhrGotoParent.onreadystatechange = function() 
			{
				if (xhrGotoParent.readyState == 4 && xhrGotoParent.status == 200)
				{
					location.reload();
				}
			};
		}

		addGoToParent()
		{
			var parentTr = document.createElement("tr");
			var parentCell = document.createElement("td");
			var gotoParentButton = document.createElement("button");
			gotoParentButton.innerHTML = "goto parent directory";
			gotoParentButton.onclick = this.__gotoParentDirectory;
			parentCell.appendChild(gotoParentButton);
			parentTr.appendChild(parentCell);
			this.table.appendChild(parentTr);
		}
	}

	var songListObj = new SongList();
	songListObj.addGoToParent();
	songListObj.queryDirectories();
	songListObj.querySongs();

</script> 
<!--
<script type="text/javascript">

	function writeSongTitle(title, songListText, scriptListText)
	{
		var postFix = title.replace(/[^a-zA-Z0-9]/g,'_').trim();
		var playSongFunction = "<script>\
		function playSong"+postFix+"() {\
			alert('Hello');\
		}\
		<\/script>";
		
		var stopSongFunction = "<script>function stopSong(){\
			alert('world');\
		}\
       	<\/script>";
		songListText += "<tr>";
		songListText += "<th>" + title + "</th>";
		songListText += playSongFunction;
		songListText += stopSongFunction;
		songListText += '<th><button onclick="playSong'+ postFix + '();">play</button></th>';

		songListText += '<th><a href="#" onclick="stopSong();">stop<i/a></th>';
songListText += "</tr>";
		return [songListText, scriptListText];
	}
	
	function createParentDirectoryEntry()
	{
			var gotoParentFunction = "<script>function gotoParent(){\
				var xhrParent = new XMLHttpRequest();\
				xhrParent.open(\"POST\", \"\", true);\
				var params = \"command=gotoParent\";\
				xhrParent.onreadystatechange = function() {\
        		if (xhrParent.readyState == 4 && xhrParent.status == 200) {\
					location.reload();\
				}};\
				xhrParent.send(params);\
				}<\/script>";
		document.write(gotoParentFunction);
		document.write('<tr><th colspan="3"><a href="#" onclick="gotoParent();">go to parent directory</a></th></tr>');
	}

	

	function createDirectoryTable()
	{
		var xhrDirectory = new XMLHttpRequest();
		xhrDirectory.open('POST', "", false)

		//Send the proper header information along with the request
		xhrDirectory.setRequestHeader("Content-type", "application/x-www-form-urlencoded");
		var params = "command=getSubDirectories";
		xhrDirectory.send(params);
		
		if (xhrDirectory.readyState == 4 && xhrDirectory.status == 200) 
		{
			document.write("<table border=1>");
			createParentDirectoryEntry();
			document.write("<tr><td>");
			document.write("testdata");
			document.write("</tr></td>");
			document.write("</table>");
		}
	}

	function createSongTable() 
	{
		//createDirectoryTable();
		
		var xhr = new XMLHttpRequest();
		xhr.open('POST', "", true);
		
		//Send the proper header information along with the request
		xhr.setRequestHeader("Content-type", "application/x-www-form-urlencoded");
		var params = "command=getSongList";
		xhr.send(params);
		xhr.onreadystatechange = processRequest;

		function processRequest()
		{
			if (xhr.readyState == 4 && xhr.status == 200) 
			{
				var response = xhr.responseText;
				if (response != "")
				{
					// first we are creating an entry to access the parent directory
					var songListString = "<table border=1>";
					var scriptListString = "";
					var songTitles = response.split('#');
					for (var i = 0; i < songTitles.length; ++i)
					{
						listString = writeSongTitle(songTitles[i], songListString, scriptListString);
						songListString = listString[0];
						scriptListString = listString[1];
				
						break;
					}
					songListString += "</table>";
					document.getElementById('songList').innerHTML = songListString;
					

					ele = document.getElementById('scriptPlace')
					ele.innerHTML = scriptListString;
					//document.write(songListString);

					var codes = ele.getElementsByTagName("script");   
					   for(var i=0;i<codes.length;i++)  
					   {  
						   alert(codes[i].text);
							eval(codes[i].text);  
					   }  
					document.close();
				}	
			}
		}
	}
</script>
-->
</BODY>
</HTML>
